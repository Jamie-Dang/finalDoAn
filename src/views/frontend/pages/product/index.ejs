<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Head -->
    <%- include('./../../layouts/elements/head') %>
    <link
      rel="stylesheet"
      href="/frontend/stylesheets/product.css"
      type="text/css"
    />
  </head>
  <body>
    <div>
      <!-- Header -->
      <%- include('./../../layouts/elements/header') %>

      <!-- Content -->
      <div class="container">
        <div class="product-detail">
          <div class="product-detail__image">
            <img src="/images/products/<%= product.image %>" class="" />
          </div>

          <form
            class="product-detail__info"
            method="post"
            onsubmit="addToCartHandler(event)"
          >
            <h2 class="product-detail__title"><%= product.name %></h2>
            <span class="product-detail__price"
              ><%= product.price.toLocaleString('vi-VN', { style: 'currency',
              currency: 'VND' }) %></span
            >
            <!-- <p class="product-detail__description">Product Description</p> -->
            <p class="product-detail__color">
              Màu sắc:
              <strong><%= product.color.name || 'Đang cập nhật' %></strong>
            </p>
            <p class="product-detail__size">Kích cỡ:</p>
            <div class="size-list">
              <% product.sizes.forEach(size => { %>
              <input
                id="size-<%= size._id %>"
                class="hidden-checkbox"
                type="checkbox"
                name="size"
                value="<%= size._id %>"
                onchange="handleCheckboxChange(this)"
              />
              <label for="size-<%= size._id %>" class="size__button"
                ><%= size.name %></label
              >
              <% }) %>
            </div>
            <div class="product-detail__action">
              <div class="quantity-box">
                <button
                  type="button"
                  class="quantity-box__button"
                  onclick="decreaseQuantityHandler()"
                >
                  -
                </button>
                <input
                  type="text"
                  class="quantity-box__input"
                  name="quantity"
                  value="1"
                />
                <button
                  type="button"
                  class="quantity-box__button"
                  onclick="increaseQuantityHandler()"
                >
                  +
                </button>
              </div>

              <input type="hidden" name="product" value="<%= product._id %>" />
              <button type="submit" class="action__cart">
                Thêm vào giỏ hàng
              </button>
            </div>
            <div class="product-policy">
              <div class="product-policy__item">
                <div class="product-policy__icon">
                  <img src="/frontend/images/product/service1.svg" alt="" />
                </div>
                <div class="product-policy__title">
                  Đổi trả cực dễ chỉ cần số điện thoại
                </div>
              </div>
              <div class="product-policy__item">
                <div class="product-policy__icon">
                  <img src="/frontend/images/product/service2.svg" alt="" />
                </div>
                <div class="product-policy__title">
                  Miễn phí vận chuyển cho đơn hàng trên 200k
                </div>
              </div>
              <div class="product-policy__item">
                <div class="product-policy__icon">
                  <img src="/frontend/images/product/service3.svg" alt="" />
                </div>
                <div class="product-policy__title">
                  60 ngày đổi trả vì bất kỳ lý do gì
                </div>
              </div>
              <div class="product-policy__item">
                <div class="product-policy__icon">
                  <img src="/frontend/images/product/service4.svg" alt="" />
                </div>
                <div class="product-policy__title">
                  Hỗ trợ từ 8h30 - 22h mỗi ngày
                </div>
              </div>
              <div class="product-policy__item">
                <div class="product-policy__icon">
                  <img src="/frontend/images/product/service5.svg" alt="" />
                </div>
                <div class="product-policy__title">
                  Đến tận nơi nhận hàng trả, hoàn tiền trong 24h
                </div>
              </div>
              <div class="product-policy__item">
                <div class="product-policy__icon">
                  <img src="/frontend/images/product/service6.svg" alt="" />
                </div>
                <div class="product-policy__title">
                  Đến tận nơi nhận hàng trả, hoàn tiền trong 24h
                </div>
              </div>
            </div>
            <h3 class="product-list__heading">Sản phẩm bạn có thể thích</h3>
            <div class="product-list">
              <% relatedProducts.forEach( product => { %>
              <a
                href="/san-pham/<%= product.slug %>?id=<%= product._id %>"
                class="product"
              >
                <img
                  src="/images/products/<%= product.image %>"
                  class="product__image"
                />
                <div class="product__info">
                  <h2 class="product__title"><%= product.name %></h2>
                  <!-- <p class="product__description">Product Description 1</p> -->
                  <span class="product__price"
                    ><%= product.price.toLocaleString('vi-VN', { style:
                    'currency', currency: 'VND' }) %></span
                  >
                </div>
              </a>
              <% }) %>
            </div>
          </form>
        </div>
      </div>

      <!-- Footer -->
      <%- include('./../../layouts/elements/footer') %>
    </div>

    <!-- Script -->
    <%- include('./../../layouts/elements/script') %>
    <script>
      function handleCheckboxChange(checkbox) {
        const checkboxes = document.getElementsByName("size");
        checkboxes.forEach(function (currentCheckbox) {
          if (currentCheckbox !== checkbox) {
            currentCheckbox.checked = false;
          }
        });
      }

      function decreaseQuantityHandler() {
        const input = document.querySelector(".quantity-box__input");
        const currentValue = parseInt(input.value);
        if (currentValue > 1) {
          input.value = currentValue - 1;
        }
      }

      function increaseQuantityHandler() {
        const input = document.querySelector(".quantity-box__input");
        const currentValue = parseInt(input.value);
        input.value = currentValue + 1;
      }

      function addToCartHandler() {
        event.preventDefault();
        const formData = new FormData(event.target);
        const formObject = Object.fromEntries(formData.entries());

        if (!formObject.size) {
          myAlert("error", "Vui lòng chọn kích cỡ");
          return;
        }

        if (!localStorage.getItem("cart")) {
          localStorage.setItem("cart", JSON.stringify([formObject]));
        }

        const cart = JSON.parse(localStorage.getItem("cart"));
        const productSizeIndex = cart.findIndex(
          (item) =>
            item.product == formObject.product && item.size == formObject.size
        );

        // const productIndex = cart.findIndex(
        //   (item) => item.product == formObject.product
        // );

        if (productSizeIndex > -1) {
          cart[productSizeIndex].quantity =
            parseInt(cart[productSizeIndex].quantity) +
            parseInt(formObject.quantity);
        }
        // else if (productIndex > -1) {
        //   cart.push(formObject);
        // }
        else {
          cart.push(formObject);
        }

        myAlert("success", "Thêm sản phẩm vào giỏ hàng thành công");

        localStorage.setItem("cart", JSON.stringify(cart));
      }
    </script>
  </body>
</html>
